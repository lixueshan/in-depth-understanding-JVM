# 第2章 Java内存区域与内存溢出异常

问题集：

> 1. **运行时数据区划分的区域。** [`Ans`](#1)
> 2. 线程共享或线程私有的区域，共享或私有的原因。
> 3. 程序计数器的定义和作用。
> 4. 执行Java方法和Native方法时程序计数器的区别。
> 5. 程序计数器涉及的异常。
> 6. 虚拟机栈的定义和作用。
> 7. **虚拟机栈的内容。**
> 8. 局部变量槽的概念，long/double占用槽位数。
> 9. 局部变量表所需内存空间确定的时机。
> 10. 局部变量表可能的异常。
> 11. 本地方法栈的定义和作用。
> 12. HotSpot的虚拟机栈和本地方法栈在内存中的关系。
> 13. 本地方法栈可能的异常。
> 14. Java堆的定义和作用。
> 15. 并非所有对象实例都存在与堆中。
> 16. 从垃圾分配和内存分配的角度划分堆。
> 17. 扩展堆空间的参数。
> 18. 堆可能的异常。
> 19. 方法区的定义和作用。
> 20. **方法区的内容。**
> 21. 方法区与堆的内存关系。
> 22. 方法区垃圾回收的对象。
> 23. 方法区可能的异常。
> 24. 运行时常量池的内容。
> 25. **运行时常量池的动态性。**
> 26. 直接内存的定义和作用。
> 27. 避免Java堆和Native堆中来回复制数据的方法。
> 28. **对象创建的过程。** [`Ans`](#28)
> 29. 对象内存的分配方式。
> 30. 同步对象内存分配动作的实现方式。
> 31. 初始化零值的时机和作用。
> 32. 执行构造器的时机。
> 33. 与new字符相关的字节码。
> 34. **对象在内存中的内容。** [`Ans`](#34)
> 35. mark word的动态性。
> 36. **mark word的所有状态，标志位，内容。** [`Ans`](#36)
> 37. 类型指针实现方式。
> 38. 如果对象是数组，对象头中还需要有的数据。
> 39. 实例数据的内容，存储顺序。
> 40. 对齐填充的定义和作用。
> 41. Java方法操作对象具体实例的方式。
> 42. 指向对象的引用的形式。
> 43. **通过句柄和通过直接指针访问对象的示意图。** [`Ans`](#43)


## 运行时数据区

JVM管理的内存可划分为如下：

- 线程私有
  - 程序计数器
  - 虚拟机栈
  - 本地方法栈
- 线程共享
  - 方法区
  - 堆

### 各区域总结

<a id="1"></a>
| 区域 | 作用 | 异常 | 备注 |
| --- | --- | --- | --- |
| 程序计数器 |  当前线程所执行字节码的行号指示器。 | 无OOM | CPU切换线程处理指令需要知道该线程处理到的位置，因此是线程私有的。 |
| 虚拟机栈 | 描述Java方法执行的线程内存模型。 | SOF/OOM | 一个方法的调用到执行结束对应一个栈帧在虚拟机栈中入栈到出栈。 |
| 本地方法栈 | 与虚拟机栈类似，但针对的是Native方法。 | SOF/OOM | HotSpot将虚拟机栈和本地方法栈合二为一。 |
| 方法区 | 存储已被虚拟机加载的类信息和即时编译后的代码缓存。 | OOM | JDK8后放弃永久代概念，以本地内存中实现的元空间来代表。物理上是对的一部分。|
| *运行时常量池 | 方法区的一部分，存放字面量，符号引用和直接引用。 | OOM | 相对class文件常量池(静态常量池)来说具有动态性。|
| 堆 | 存放几乎所有对象实例。 | OOM | 物理可不连续，逻辑连续。<br>可扩展(-Xmx/-Xms)。<br>从垃圾管理角度可分为不同年代区域。<br>从分配内存角度，可废除多个线程私有的分配缓冲区(TLAB)|

### 运行时数据区思维导图

![运行时数据区](https://tva1.sinaimg.cn/large/008i3skNgy1guk1zb43zsj60u00vdgnu02.jpg)

## HotSpot虚拟机对象探秘

**对象创建的过程**

<a id="28"></a>
1. 遇到new指令，检查该指令参数能否在常量池中定位到一个类的符号引用。
2. 检查该符号引用代表的类是否已被加载，解析和初始化过。
3. 如无，先执行类加载过程。
4. 加载检查通过后，为该对象分配内存。
    - 分配方式：指针碰撞 / 空闲列表
    - 分配动作的原子性：CAS+失败重试
5. 初始化零值。
6. 设置对象头。

**对象的内存布局**

堆中对象实例存储的内容见思维导图。

<a id="36"></a>
mark word的动态性
```
根据对象的不同状态复用自己的存储空间(32或64比特)。如未锁定状态下，32比特中25比特存储对象哈希码，4比特存储对象分代年龄，2比特存储锁标志位，1比特固定为0.
```
![mark word](https://tva1.sinaimg.cn/large/008i3skNgy1gukpi5lnw9j612w0c4gnd02.jpg)

**对象的访问方式**

<a id="43"></a>
![通过句柄访问对象](https://tva1.sinaimg.cn/large/008i3skNgy1gukp7d1d7ej611u0jawgn02.jpg)

![通过直接指针访问对象](https://tva1.sinaimg.cn/large/008i3skNgy1gukp6i24yqj611y0ja76a02.jpg)

### Hotspot对象探秘思维导图

<a id="34"></a>
![](https://tva1.sinaimg.cn/large/008i3skNgy1gukpb7or6hj61270u0wh202.jpg)